library(dplyr)
library(readr)
library(sjlabelled)

rm(list=ls())

source("util/util.fn.R")


path_code <- "path/to/survey_R_data_file_code.csv"

path_source <- "path/to/survey_R_syntax_file.R"

# store data frame. 
path_save <- ""

# Read LimeSurvey exported R data file (with tabs!)
data <- read_tsv(path_code)
data <- as.data.frame(data)

# Conversion to factor 
# 1. Remove first line of syntax file before source! LimeSurvey writes the read.csv into it. 
#
# 2. Country and citizenship: use variables from country_labels.R Otherwise will throw error. 
#    Comment out var 247 and var 248 before source. 

source(path_data) 

# 3. Load country labels into variable "clabels"
source("util/country_labels_EN.R") 

# 4. Assign country and citizen labels. 
if (!is.null(data$SDEM012)){
    data[, "SDEM012"] <- factor(data[, "SDEM012"], levels=c("L001","L002","L003","L004","L005","L006","L007","L008","L009","L010","L011","L012","L013","L014","L015","L016","L017","L018","L019","L020","L021","L022","L023","L024","L025","L026","L027","L028","L029","L030","L031","L032","L033","L034","L035","L036","L037","L038","L039","L040","L041","L042","L043","L044","L045","L046","L047","L048","L049","L050","L051","L052","L053","L054","L055","L056","L057","L058","L059","L060","L061","L062","L063","L064","L065","L066","L067","L068","L069","L070","L071","L072","L073","L074","L075","L076","L077","L078","L079","L080","L081","L082","L083","L084","L085","L086","L087","L088","L089","L090","L091","L092","L093","L094","L095","L096","L097","L098","L099","L100","L101","L102","L103","L104","L105","L106","L107","L108","L109","L110","L111","L112","L113","L114","L115","L116","L117","L118","L119","L120","L121","L122","L123","L124","L125","L126","L127","L128","L129","L130","L131","L132","L133","L134","L135","L136","L137","L138","L139","L140","L141","L142","L143","L144","L145","L146","L147","L148","L149","L150","L151","L152","L153","L154","L155","L156","L157","L158","L159","L160","L161","L162","L163","L164","L165","L166","L167","L168","L169","L170","L171","L172","L173","L174","L175","L176","L177","L178","L179","L180","L181","L182","L183","L184","L185","L186","L187","L188","L189","L190","L191","L192","L193","L194","L195","L196","L197","L198","L199","L200","L201","L202","L203","L204","L205","L206","L207","L208","L209","L210","L211","L212","L213","L214","L215","L216","L217","L218","L219","L220","L221","L222","L223","L224","L225","L226","L227","L228","L229","L230","L231","L232","L233","L234","L235","L236","L237","L238","L239","L240","L241","L242","L243","L244","L245","L246","L247","L248","L249","L250","L251","L252","L253","L254","L255","L256","L257","L258","L259","L260","L261","L262","L263","L264","L265","L266","L267","L268","L269","L270","L271","L272","L273","L274","L275","L276","L277","L278","L279","L280","L281","L282","L283","L284","L285"),labels=clabels)
}

if (!is.null(data$SDEM013)){
    data[, "SDEM013"] <- factor(data[, "SDEM013"], levels=c("L001","L002","L003","L004","L005","L006","L007","L008","L009","L010","L011","L012","L013","L014","L015","L016","L017","L018","L019","L020","L021","L022","L023","L024","L025","L026","L027","L028","L029","L030","L031","L032","L033","L034","L035","L036","L037","L038","L039","L040","L041","L042","L043","L044","L045","L046","L047","L048","L049","L050","L051","L052","L053","L054","L055","L056","L057","L058","L059","L060","L061","L062","L063","L064","L065","L066","L067","L068","L069","L070","L071","L072","L073","L074","L075","L076","L077","L078","L079","L080","L081","L082","L083","L084","L085","L086","L087","L088","L089","L090","L091","L092","L093","L094","L095","L096","L097","L098","L099","L100","L101","L102","L103","L104","L105","L106","L107","L108","L109","L110","L111","L112","L113","L114","L115","L116","L117","L118","L119","L120","L121","L122","L123","L124","L125","L126","L127","L128","L129","L130","L131","L132","L133","L134","L135","L136","L137","L138","L139","L140","L141","L142","L143","L144","L145","L146","L147","L148","L149","L150","L151","L152","L153","L154","L155","L156","L157","L158","L159","L160","L161","L162","L163","L164","L165","L166","L167","L168","L169","L170","L171","L172","L173","L174","L175","L176","L177","L178","L179","L180","L181","L182","L183","L184","L185","L186","L187","L188","L189","L190","L191","L192","L193","L194","L195","L196","L197","L198","L199","L200","L201","L202","L203","L204","L205","L206","L207","L208","L209","L210","L211","L212","L213","L214","L215","L216","L217","L218","L219","L220","L221","L222","L223","L224","L225","L226","L227","L228","L229","L230","L231","L232","L233","L234","L235","L236","L237","L238","L239","L240","L241","L242","L243","L244","L245","L246","L247","L248","L249","L250","L251","L252","L253","L254","L255","L256","L257","L258","L259","L260","L261","L262","L263","L264","L265","L266","L267","L268","L269","L270","L271","L272","L273","L274","L275","L276","L277","L278","L279","L280","L281","L282","L283","L284","L285"),labels=clabels)
}


# Convert to "real" labels with sjlabelled, i.e. makes labels accessible in sjPlots 
data <- set_label(data, attributes(data)$variable.labels) 

orgtype <- as.character(data$VarOrgType[1])

# Remove question from answer items
cols <- data %>% 
    select(matches("_SQ0")) %>% 
    names()

# Not sure why attr does not work with sapply. 
for (i in cols){
    attr(data[,i], which="question_label") <- match_label(data[,i], type="question", orgtype=orgtype)     
}


# Get answer options and set as label. 
data[,cols] <- set_label(data[,cols], sapply(data[,cols],match_label, type="answer", orgtype=orgtype))


save(data, file=path_save)






